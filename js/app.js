// Generated by CoffeeScript 1.4.0
(function() {
  var KeyTools, Paper, SoundManager,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.keys = {
    ENTER: 13,
    SPACE: 32,
    BACKSPACE: 8
  };

  KeyTools = (function() {

    function KeyTools() {}

    KeyTools.normal = function(keyCode) {
      return KeyTools._withinRange(keyCode, 48, 90) || KeyTools._withinRange(keyCode, 186, 222);
    };

    KeyTools._withinRange = function(sample, min, max) {
      return sample >= min && sample <= max;
    };

    return KeyTools;

  }).call(this);

  SoundManager = (function() {

    SoundManager.prototype.SOUND_BASE = 'sounds/';

    SoundManager.prototype.options = {
      volume: 0.75,
      target: '#text'
    };

    function SoundManager() {
      this.loadAudioFiles();
      this.setupDom();
      this.keystrokeCount = 0;
    }

    SoundManager.prototype.loadAudioFiles = function() {
      var audioObj, bufferSize, file, i, name, sound, _ref, _results;
      this.sounds = {
        standard: {
          timeout: 0,
          files: ["k1p.wav", "k2p.wav", "k3p.wav", "k4p.wav"]
        },
        space: {
          timeout: 250,
          files: ["spacebar.wav"]
        },
        enter: {
          timeout: 700,
          files: ["returncarriage.wav"]
        },
        backspace: {
          timeout: 200,
          files: ["backspace.wav"]
        }
      };
      bufferSize = 5;
      _ref = this.sounds;
      _results = [];
      for (name in _ref) {
        sound = _ref[name];
        this.sounds[name].sounds = [];
        _results.push((function() {
          var _i, _ref1, _results1;
          _results1 = [];
          for (i = _i = 0, _ref1 = bufferSize - 1; 0 <= _ref1 ? _i <= _ref1 : _i >= _ref1; i = 0 <= _ref1 ? ++_i : --_i) {
            _results1.push((function() {
              var _j, _len, _ref2, _results2;
              _ref2 = sound.files;
              _results2 = [];
              for (_j = 0, _len = _ref2.length; _j < _len; _j++) {
                file = _ref2[_j];
                audioObj = new Audio(this.SOUND_BASE + file);
                audioObj.volume = this.options.volume;
                this.sounds[name].sounds.push(audioObj);
                _results2.push(this.sounds[name].lastPlayed = 0);
              }
              return _results2;
            }).call(this));
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    SoundManager.prototype._withinRange = function(sample, min, max) {
      return sample > min && sample < max;
    };

    SoundManager.prototype._playSound = function(soundName) {
      var playable, sound, sounds, time;
      sound = this.sounds[soundName];
      time = new Date().getTime();
      if (!(sound.timeLastPlayed != null) || time - sound.timeLastPlayed > sound.timeout) {
        sounds = sound.sounds;
        playable = sounds[this.keystrokeCount % sounds.length];
        playable.play();
        sound.timeLastPlayed = time;
        return true;
      }
      return false;
    };

    SoundManager.prototype.setupDom = function() {
      var $txt,
        _this = this;
      $txt = $(this.options.target);
      $txt.on('keydown', function(e) {
        var played;
        _this.keystrokeCount++;
        if (KeyTools.normal(e.keyCode)) {
          return played = _this._playSound('standard');
        } else {
          switch (e.keyCode) {
            case keys.ENTER:
              return played = _this._playSound('enter');
            case keys.SPACE:
              return played = _this._playSound('space');
            case keys.BACKSPACE:
              return played = _this._playSound('backspace');
          }
        }
      });
      $(document).on('click', function() {
        return $txt.focus();
      });
      return $txt.focus();
    };

    return SoundManager;

  })();

  new SoundManager();

  Paper = (function() {

    function Paper(id) {
      this.printCharacter = __bind(this.printCharacter, this);

      this.adjustCol = __bind(this.adjustCol, this);

      this.adjustRow = __bind(this.adjustRow, this);

      this.adjustPosition = __bind(this.adjustPosition, this);
      this.canvas = document.getElementById(id);
      this.$canvas = $(this.canvas);
      this.ctx = this.canvas.getContext('2d');
      this.ctx.fillStyle = "rgba(255, 50, 50, 0.7)";
      this.ctx.font = "20px monospace";
      this.charWidth = 15;
      this.lineHeight = 30;
      this.col = 0;
      this.row = 0;
      $(document).on('keydown', this.adjustPosition);
      $(document).on('keypress', this.printCharacter);
    }

    Paper.prototype.adjustPosition = function(e) {
      switch (e.keyCode) {
        case keys.ENTER:
          return this.adjustRow(1);
        case keys.SPACE:
          return this.adjustCol(1);
        case keys.BACKSPACE:
          return this.adjustCol(-1);
        default:
          if (KeyTools.normal(e.keyCode)) {
            return this.adjustCol(1);
          }
      }
    };

    Paper.prototype.adjustRow = function(value) {
      this.row += value;
      this.col = 0;
      return this.$canvas.css('-webkit-transform', "translate(0," + (-this.row * this.lineHeight) + "px)");
    };

    Paper.prototype.adjustCol = function(value) {
      if (this.col + value >= 0) {
        this.col += value;
        this.left -= value * this.charWidth;
        return this.$canvas.css('-webkit-transform', "translate(" + (-this.col * this.charWidth) + "px," + (-this.row * this.lineHeight) + "px)");
      }
    };

    Paper.prototype.printCharacter = function(e) {
      return this.ctx.fillText(String.fromCharCode(e.charCode), this.charWidth * this.col, this.lineHeight * this.row + this.lineHeight);
    };

    return Paper;

  })();

  new Paper('paper');

}).call(this);
